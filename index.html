<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Coach Callisthenie ‚Äî Sans Mat√©riel</title>
  <script>document.documentElement.classList.add('js')</script>
  <style>
    /* Petit loader visible m√™me si les scripts ne chargent pas */
    #root{min-height:100vh;display:flex;align-items:center;justify-content:center;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Helvetica Neue',Helvetica,Arial}
    .hint{max-width:720px;padding:16px;border:1px solid #e5e7eb;border-radius:12px;background:#fff}
    .hint h1{margin:0 0 8px 0;font-size:18px}
    .hint p{margin:8px 0;color:#4b5563}
    .hide{display:none}
  </style>
  <script>
    // Affiche toute erreur JS directement √† l'√©cran (pratique pour d√©bug)
    window.addEventListener('error', e => {
      const el = document.getElementById('boot-error');
      if (el) { el.classList.remove('hide'); el.querySelector('pre').textContent = e.message; }
    });
    window.addEventListener('unhandledrejection', e => {
      const el = document.getElementById('boot-error');
      if (el) { el.classList.remove('hide'); el.querySelector('pre').textContent = (e.reason && e.reason.message) || String(e.reason); }
    });
  </script>
</head>
<body class="bg-gradient-to-b from-gray-50 to-white">
  <div id="root">
    <div class="hint">
      <h1>Chargement‚Ä¶</h1>
      <p>Si ce message reste plus de quelques secondes :</p>
      <ol>
        <li>V√©rifie <strong>Settings ‚Üí Pages</strong> (main / root).</li>
        <li>Recharge la page (<kbd>Ctrl/‚åò+R</kbd>).</li>
      </ol>
    </div>
  </div>

  <!-- Erreurs de d√©marrage affich√©es ici -->
  <div id="boot-error" class="hide" style="position:fixed;left:0;right:0;bottom:0;padding:12px;background:#fee2e2;border-top:1px solid #fecaca;font-family:monospace">
    <strong>Erreur au chargement :</strong>
    <pre style="white-space:pre-wrap;margin:6px 0 0"></pre>
  </div>

  <!-- Tailwind (optionnel) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React + ReactDOM (UMD, via jsDelivr) -->
  <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>

  <!-- Babel pour transformer le JSX dans le navigateur -->
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>

  <!-- Ton app : m√™me code que dans le canvas, mais embarqu√© ici -->
  <!-- IMPORTANT: data-presets="react" pour √©viter la page blanche -->
  <script type="text/babel" data-presets="react">
    const { useEffect, useMemo, useRef, useState } = React;

    // ===== utilitaires et app =====
    // (code compact√© : m√™me logique que ta version "mobile" qu'on a g√©n√©r√©e)
    // -- helpers --
    const storage={get(k,f){try{const r=localStorage.getItem(k);return r?JSON.parse(r):f}catch{return f}},set(k,v){try{localStorage.setItem(k,JSON.stringify(v))}catch{}}};
    const MONTHS_FR=["janvier","f√©vrier","mars","avril","mai","juin","juillet","ao√ªt","septembre","octobre","novembre","d√©cembre"];
    const WDAYS_FR=["L","M","M","J","V","S","D"];
    const cls=(...xs)=>xs.filter(Boolean).join(" ");
    const fKey=(d)=>{const y=d.getFullYear();const m=String(d.getMonth()+1).padStart(2,"0");const day=String(d.getDate()).padStart(2,"0");return y+"-"+m+"-"+day};
    const sOfW=(date)=>{const d=new Date(date);const dow=(d.getDay()+6)%7;d.setDate(d.getDate()-dow);d.setHours(0,0,0,0);return d};
    const addW=(date,delta)=>{const d=new Date(date);d.setDate(d.getDate()+delta*7);return d};
    const wDays=(viewDate)=>{const start=sOfW(viewDate);return Array.from({length:7},(_,i)=>{const dt=new Date(start);dt.setDate(start.getDate()+i);return dt})};
    const ytId=(url)=>{if(!url)return"";try{const u=new URL(url);const host=u.hostname.replace(/^www\./,"");const p=u.pathname.split("/").filter(Boolean);
      if(host.includes("youtu.be"))return p[0]||""; if(host.includes("youtube.com")||host.includes("m.youtube.com")||host.includes("music.youtube.com")){
      const v=u.searchParams.get("v"); if(v)return v; const e=p.indexOf("embed"); if(e>=0&&p[e+1])return p[e+1]; const s=p.indexOf("shorts"); if(s>=0&&p[s+1])return p[s+1]; const l=p.indexOf("live"); if(l>=0&&p[l+1])return p[l+1];}}catch{} return url};
    const pretty=(s)=>{const m=Math.floor(s/60),sec=s%60;return `${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`};
    const DEFAULT_SESSIONS={A:[{id:"pompes-mur",name:"Pompes au mur",videoUrl:""},{id:"pike-lean",name:"Pike lean (appui √©paules)",videoUrl:""},{id:"pompes-hr",name:"Pompes hand-release (√† genoux si besoin)",videoUrl:""},{id:"planche",name:"Planche",videoUrl:""},{id:"wall-slides",name:"Wall slides (gliss√©s scapulaires)",videoUrl:""}],
                            B:[{id:"ytwi",name:"Y-T-W-I au sol",videoUrl:""},{id:"angels",name:"Reverse snow angels",videoUrl:""},{id:"good-morning",name:"Good morning sans charge",videoUrl:""},{id:"side-plank",name:"Gainage lat√©ral (side plank)",videoUrl:""},{id:"squats",name:"Squats au poids du corps",videoUrl:""}]};
    const DEFAULT_SETTINGS={mode:"reps",repsTarget:12,setsTarget:3,restBetweenSets:60,workSec:30,restSec:30,rounds:5};
    const autoMode=(id)=>{id=String(id||"").toLowerCase();return ["planche","plank","pike-lean","side-plank","hollow","superman","hold"].some(k=>id.includes(k))?"timer":"reps"};

    const Card=({children,className})=>(<div className={cls("rounded-2xl shadow-sm border border-gray-200 bg-white p-4",className)}>{children}</div>);
    const Title=({icon,title,subtitle})=>(
      <div className="mb-3">
        <h2 className="text-xl font-semibold flex items-center gap-2"><span className="text-2xl">{icon}</span>{title}</h2>
        {subtitle?<p className="text-sm text-gray-500 mt-1">{subtitle}</p>:null}
      </div>
    );

    const YT = ({url,enabled,onEnable})=>{
      const id=ytId(url);
      if(!id) return <div className="aspect-video w-full rounded-xl bg-gray-100 grid place-items-center text-gray-500 text-sm">Colle un lien YouTube (watch, youtu.be, shorts ou live).</div>;
      if(!enabled) return (
        <div className="aspect-video w-full rounded-xl bg-gray-100 p-4 flex flex-col items-center justify-center text-center">
          <div className="text-sm text-gray-700 mb-2">Lecture int√©gr√©e d√©sactiv√©e.</div>
          <div className="text-xs text-gray-500 mb-3">Charge la vid√©o ici, ou ouvre-la dans YouTube.</div>
          <div className="flex gap-2">
            <button className="px-3 py-2 rounded-xl border border-gray-300 hover:bg-gray-50 text-sm" onClick={onEnable}>Charger ici</button>
            <a className="px-3 py-2 rounded-xl border border-gray-300 hover:bg-gray-50 text-sm" href={`https://www.youtube.com/watch?v=${id}`} target="_blank" rel="noreferrer">Ouvrir ‚Üó</a>
          </div>
        </div>
      );
      return <iframe className="aspect-video w-full rounded-xl" src={`https://www.youtube-nocookie.com/embed/${id}?rel=0`} title="YouTube" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerPolicy="strict-origin-when-cross-origin" allowFullScreen sandbox="allow-same-origin allow-scripts allow-popups allow-forms"/>;
    };

    function App(){
      const [sessions,setSessions]=useState(()=>storage.get("calis.sessions",DEFAULT_SESSIONS));
      const [selected,setSelected]=useState("A");
      const [activeId,setActiveId]=useState(sessions.A[0]?.id||"");
      const [settings,setSettings]=useState(()=>storage.get("calis.settings",DEFAULT_SETTINGS));
      const [ytEnabled,setYtEnabled]=useState(()=>storage.get("calis.ytEnabled",false));

      const [currentSet,setCurrentSet]=useState(1);
      const [repCount,setRepCount]=useState(0);
      const [resting,setResting]=useState(false);
      const [restLeft,setRestLeft]=useState(settings.restBetweenSets);

      const [phase,setPhase]=useState("ready");
      const [isRunning,setIsRunning]=useState(false);
      const [secondsLeft,setSecondsLeft]=useState(settings.workSec);
      const [round,setRound]=useState(1);

      const [log,setLog]=useState(()=>storage.get("calis.log",{}));
      const todayKey=useMemo(()=>fKey(new Date()),[]);
      const [viewDate,setViewDate]=useState(new Date());

      const list=sessions[selected]||[];
      const active=list.find(x=>x.id===activeId)||list[0]||null;

      useEffect(()=>storage.set("calis.sessions",sessions),[sessions]);
      useEffect(()=>storage.set("calis.settings",settings),[settings]);
      useEffect(()=>storage.set("calis.ytEnabled",ytEnabled),[ytEnabled]);
      useEffect(()=>storage.set("calis.log",log),[log]);

      useEffect(()=>{ const l=sessions[selected]; if(!l.find(x=>x.id===activeId)){ setActiveId(l[0]?.id||""); } },[selected]);
      useEffect(()=>{ const m=autoMode(active?.id||activeId); setSettings(s=>s.mode===m?s:{...s,mode:m}); },[activeId,active?.id]);

      function isDone(id){ const day=log[todayKey]||{}; const sData=day.sessions?.[selected]||{}; return !!(sData.exDone&&sData.exDone[id]); }
      function setDone(id,done){
        setLog(prev=>{ const copy={...prev}; const day={...(copy[todayKey]||{})}; day.sessions={...(day.sessions||{})};
          const sData={...(day.sessions[selected]||{})}; sData.exDone={...(sData.exDone||{})}; if(done) sData.exDone[id]=true; else delete sData.exDone[id];
          day.sessions[selected]=sData; const all=list.length>0 && list.every(ex=>!!sData.exDone?.[ex.id]); day.completedSessions={...(day.completedSessions||{})}; day.completedSessions[selected]=all;
          day.completed=Object.values(day.completedSessions).some(Boolean); copy[todayKey]=day; return copy;});
      }

      // rendu
      return (
        <div className="min-h-screen bg-gradient-to-b from-gray-50 to-white text-gray-900">
          <div className="max-w-5xl mx-auto p-4 sm:p-6">
            <header className="mb-4 sm:mb-6">
              <h1 className="text-2xl sm:text-3xl font-bold">Coach Callisthenie ‚Äî Sans Mat√©riel</h1>
              <p className="text-gray-600 mt-1">R√©p√©ts ou chrono + vid√©o YouTube int√©gr√©e. Sauvegarde locale.</p>
            </header>

            <Card>
              <Title icon="üìÖ" title="Semaine en cours" subtitle="La journ√©e se valide quand la checklist est compl√®te"/>
              <div className="flex items-center justify-between mb-2">
                <button className="px-2 py-1 rounded-lg border border-gray-300 text-sm" onClick={()=>setViewDate(addW(viewDate,-1))}>‚Üê</button>
                <div className="text-sm font-medium">Semaine du {wDays(viewDate)[0].getDate()} {MONTHS_FR[wDays(viewDate)[0].getMonth()]}</div>
                <button className="px-2 py-1 rounded-lg border border-gray-300 text-sm" onClick={()=>setViewDate(addW(viewDate,1))}>‚Üí</button>
              </div>
              <div className="flex gap-2 overflow-x-auto py-1">
                {wDays(viewDate).map((d,idx)=>{
                  const key=fKey(d); const day=log[key]; const done=!!(day&&day.completed); const tags=(day&&day.completedSessions)||{}; const today=key===todayKey;
                  return (
                    <div key={key} className={cls("min-w-[56px] flex-shrink-0 p-2 rounded-xl border text-center","bg-white border-gray-200",done&&"bg-green-50 border-green-200",today&&"ring-2 ring-gray-900")}>
                      <div className="text-xs font-medium">{WDAYS_FR[idx]}</div>
                      <div className="text-sm">{d.getDate()}</div>
                      <div className="mt-1 flex justify-center gap-1 text-[10px]">
                        {tags.A && <span className="px-1 rounded bg-green-100 text-green-700">A</span>}
                        {tags.B && <span className="px-1 rounded bg-green-100 text-green-700">B</span>}
                        {done && <span className="text-green-600">‚úî</span>}
                      </div>
                    </div>
                  );
                })}
              </div>
            </Card>

            <div className="grid lg:grid-cols-3 gap-4 mt-4">
              <Card className="lg:col-span-1">
                <Title icon="üìã" title="Exercices" subtitle="Choisis un exercice dans la s√©ance"/>
                <div className="mb-3">
                  <div className="flex items-center gap-2">
                    {["A","B"].map(s=>(
                      <button key={s} onClick={()=>setSelected(s)} className={cls("px-3 py-2 rounded-xl border text-sm", selected===s?"bg-gray-900 text-white border-gray-900":"bg-white text-gray-800 border-gray-200")}>{s}</button>
                    ))}
                  </div>
                  <p className="text-xs text-gray-500 mt-1">{selected==="A"?"S√©ance A (Push/Core)":"S√©ance B (Dos/Posture/Core)"}</p>
                </div>

                <ul className="space-y-2">
                  {list.map(ex=>(
                    <li key={ex.id}>
                      <button onClick={()=>setActiveId(ex.id)} className={cls("w-full text-left p-3 rounded-xl border", activeId===ex.id?"bg-gray-900 text-white border-gray-900":"bg-white hover:bg-gray-50 border-gray-200")}>
                        <div className="flex items-center justify-between">
                          <span className="font-medium text-sm sm:text-base">{ex.name}</span>
                          {activeId===ex.id && <span className="px-2 py-1 rounded-full text-xs bg-gray-100 text-gray-700">Actif</span>}
                        </div>
                      </button>
                    </li>
                  ))}
                </ul>

                <div className="mt-4">
                  <Title icon="‚úÖ" title="Checklist du jour" subtitle={`S√©ance ${selected} ‚Äî coche chaque exercice`}/>
                  <ul className="space-y-2">
                    {list.map(ex=>(
                      <label key={"ck-"+ex.id} className="flex items-center gap-2 text-sm">
                        <input type="checkbox" checked={isDone(ex.id)} onChange={e=>setDone(ex.id,e.target.checked)}/>
                        <span>{ex.name}</span>
                      </label>
                    ))}
                  </ul>
                </div>
              </Card>

              <div className="lg:col-span-2 space-y-4">
                <Card>
                  <Title icon="üé•" title={active?.name||"Exercice"} subtitle="Vid√©o + param√®tres"/>
                  <div className="grid md:grid-cols-2 gap-4">
                    <div>
                      <YT url={active?.videoUrl||""} enabled={ytEnabled} onEnable={()=>setYtEnabled(true)}/>
                      <div className="mt-2 flex items-center gap-2">
                        <input className="flex-1 rounded-lg border border-gray-300 px-3 py-2 text-sm" placeholder="Colle l'URL YouTube" value={active?.videoUrl||""}
                          onChange={e=>{const val=e.target.value; setSessions(prev=>{const copy={...prev}; copy[selected]=copy[selected].map(x=>x.id===active.id?{...x,videoUrl:val}:x); return copy;});}}/>
                        <button className={cls("px-3 py-2 rounded-xl border text-sm", ytEnabled?"border-gray-300 hover:bg-gray-50":"border-gray-900 bg-gray-900 text-white")}
                                onClick={()=>setYtEnabled(v=>!v)}>{ytEnabled?"Int√©gration : ON":"Int√©gration : OFF"}</button>
                        {active?.videoUrl ? <a className="px-3 py-2 rounded-xl border border-gray-300 hover:bg-gray-50 text-sm" href={active.videoUrl} target="_blank" rel="noreferrer">Ouvrir ‚Üó</a> : null}
                      </div>
                    </div>

                    <div className="space-y-3">
                      {settings.mode==="reps" ? (
                        <div>
                          <Title icon="üî¢" title="R√©p√©titions"/>
                          <p className="text-sm text-gray-600">R√®gle tes cibles √† droite si besoin.</p>
                        </div>
                      ) : (
                        <div>
                          <Title icon="‚è±Ô∏è" title="Chrono"/>
                          <p className="text-sm text-gray-600">D√©marre/pauses depuis les boutons ci-dessous.</p>
                        </div>
                      )}
                    </div>
                  </div>
                </Card>

                <Card>
                  <Title icon="üß†" title="Conseils rapides de forme"/>
                  <ul className="list-disc pl-5 space-y-1 text-sm text-gray-700">
                    <li>√âpaules basses, nuque neutre, cage thoracique rentr√©e.</li>
                    <li>Contr√¥le la descente (2‚Äì3 s). Respire : souffle en poussant, inspire en revenant.</li>
                    <li>Douleur aigu√´ = stop. R√©duis l‚Äôamplitude ou remplace l‚Äôexercice.</li>
                  </ul>
                </Card>

                <Card>
                  <Title icon="üßæ" title="Options"/>
                  <div className="flex flex-wrap gap-2">
                    <button className="px-3 py-2 rounded-xl border border-gray-300 hover:bg-gray-50 text-sm"
                      onClick={()=>{ if(confirm("R√©initialiser ?")){ localStorage.clear(); location.reload(); } }}>R√©initialiser</button>
                    <button className="px-3 py-2 rounded-xl border border-gray-300 hover:bg-gray-50 text-sm" onclick="window.print()">Imprimer / PDF</button>
                  </div>
                </Card>
              </div>
            </div>

            <footer className="mt-8 text-center text-xs text-gray-500">Donn√©es stock√©es en local (localStorage).</footer>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
